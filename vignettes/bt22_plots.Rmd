---
title: "BT 22 example plots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{bt22_plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

ACHTUNG: Schaut bitte selbst noch einmal genau, welche Spalten ihr zum Plotten benötigt. Die Plots sind zur Veranschaulichung des Workflows gedacht, es kann sein, dass ihr für bestimmte Kapitel andere Spalten angeben müsst! Also vergleicht am besten noch einmal Stichprobenartig mit dem `eatRep` output, dass es sich um die richtigen Werte handelt.

```{r setup}
library(eatPlot)
```

# Lineplots
## Chapter 4: Kompetenzwerte Bundesländer
```{r chpt4_line}
## Prepare the data with 'KBuecher_imp3' as grouping_var
plot_dat <- prep_plot(
  dat = trend_books,
  competence = "GL",
  grouping_vars = "KBuecher_imp3",
  grouping_vars_groups = c("0", "1")
)

## Remove wholeGroup, as we don't want to plot it
plot_dat <- filter_rows(plot_dat,
  column_name = "state_var",
  subsetter = "wholeGroup",
  remove = TRUE
)

p_line_states <- plot_lineplot(
  plot_dat = plot_dat,
  years_lines = list(c(2011, 2016), c(2016, 2021)),
  years_braces = list(c(2011, 2016), c(2016, 2021)),
  plot_settings = plotsettings_lineplot(default_list = lineplot_4x4)
)

p_line_states
```

```{r, eval = FALSE}
save_plot(p_line_states, filename = "../split_lineplot_2_books.pdf")
```


## Chapter 4: Kompetenzwerte Deutschland
```{r chpt_4_ger}
## First we extract the wanted competence areas from the data:
plot_dat_kb <- trend_books[trend_books$kb %in% c("DHW", "GL", "GM", "hoeren", "lesen"), ]

## Than we can prepare it with the according function:
plot_dat_test <- prep_plot(
  dat = plot_dat_kb,
  grouping_var = "KBuecher_imp3",
  grouping_var_groups = c("0", "1"),
  states = "wholeGroup"
)

## Here we change the seperate_plot_var - Argument to "competence_var", so the different competences are depicted in the tiles:
p_line_ger <- plot_lineplot(
  plot_dat = plot_dat_test,
  seperate_plot_var = "competence_var",
  label_sig_high = NULL,
  years_lines = list(c(2011, 2016), c(2016, 2021)),
  years_braces = list(c(2011, 2016), c(2016, 2021)),
  background_lines = FALSE,
  plot_settings = plotsettings_lineplot(
    default_list = lineplot_2x3
  )
)

p_line_ger
```

```{r, eval = FALSE}
## We dont't want a whole A4 page for this plot, but maybe the half:
save_plot(p_line_ger,
  filename = "../adjusted_means_ger.pdf",
  height = 226.2 / 2 + 10
)
```


# Tables/Barplots
## Chapter 3: Mindeststandards
```{r chpt_3_MinStand}
dat_bar <- prep_plot(min_stand,
  competence = "lesen",
  parameter = "1"
)[["plot_tablebar"]]

## Some columns have to be prepared manually (with convenience functions):
## wholeGroup should not be plotted in bold, so set to FALSE
dat_bar[dat_bar$state_var == "wholeGroup", grep("sig_", colnames(dat_bar))] <- FALSE

dat_bar <- construct_percent(dat_bar, columns = colnames(dat_bar)[grep("est", colnames(dat_bar))])
for (i in c("2011", "2016", "2021")) {
  dat_bar <- construct_directional_sig(dat_bar, est_column = paste0("est_noTrend_CompCrossDiffWhole_", i), sig_column = paste0("sig_noTrend_CompCrossDiffWhole_", i))
}

dat_bar$state_var <- gsub("wholeGroup", "Deutschland", dat_bar$state_var)

# Plot 1 ------------------------------------------------------------------
dat_bar_1 <- subset(dat_bar, depVar == "minVerfehlt")

p_bar_1 <- plot_tablebar(
  dat = dat_bar_1,
  bar_label = "est_noTrend_noComp_2021_percent",
  bar_label_sig = "sig_noTrend_CompCrossDiffWhole_2021",
  bar_sig = "sig_noTrend_CompCrossDiffWhole_2021_directional_sig",
  bar_header = "**Mindeststandard nicht erreicht**",
  columns_headers = list("**Land**"),
  columns_table = list("state_var"),
  bar_est = "est_noTrend_noComp_2021_percent",
  y_axis = "state_var",
  plot_settings = plotsettings_tablebarplot(
    axis_x_lims = c(0, 40),
    bar_fill_colour = grDevices::rgb(49, 133, 156, maxColorValue = 255),
    columns_alignment = 0,
    columns_width = c(0.45, 0.55),
    headers_alignment = 0,
    default_list = barplot_plot_frame
  )
)


# Plot 2 ------------------------------------------------------------------

dat_bar_2 <- subset(dat_bar, depVar == "regErreicht")

p_bar_2 <- plot_tablebar(
  dat = dat_bar_2,
  bar_label = "est_noTrend_noComp_2021_percent",
  bar_label_sig = "sig_noTrend_CompCrossDiffWhole_2021",
  bar_sig = "sig_noTrend_CompCrossDiffWhole_2021_directional_sig",
  bar_header = "**Regelstandard erreicht oder übertroffen**",
  bar_est = "est_noTrend_noComp_2021_percent",
  y_axis = "state_var",
  plot_settings = plotsettings_tablebarplot(
    columns_alignment = 0,
    headers_alignment = 0,
    columns_width = NULL,
    axis_x_lims = c(0, 75),
    bar_fill_colour = grDevices::rgb(75, 172, 198, maxColorValue = 255),
    default_list = barplot_plot_frame
  )
)



# Plot 3 ------------------------------------------------------------------
dat_bar_3 <- subset(dat_bar, depVar == "optErreicht")

p_bar_3 <- plot_tablebar(
  dat = dat_bar_3,
  bar_label = "est_noTrend_noComp_2021_percent",
  bar_label_sig = "sig_noTrend_CompCrossDiffWhole_2021",
  bar_sig = "sig_noTrend_CompCrossDiffWhole_2021_directional_sig",
  bar_header = "**Optimalstandard<br>erreicht**",
  bar_est = "est_noTrend_noComp_2021_percent",
  y_axis = "state_var",
  plot_settings = plotsettings_tablebarplot(
    axis_x_lims = c(0, 25),
    default_list = barplot_plot_frame
  )
)

# Combine plots --------------
minsta_plot <- combine_plots(list(p_bar_1, p_bar_2, p_bar_3))

minsta_plot
```

```{r, eval = FALSE}
save_plot(minsta_plot, filename = "../Kap3_2022_MSA-v02.pdf", height = 226.2 / 3)
```


## Chapter 4: Mindeststandards Trend
```{r chpt_3_MinStand_trend}
dat_bar <- prep_plot(min_stand,
  competence = "lesen",
  parameter = "1"
)[["plot_tablebar"]]


dat_bar <- construct_percent(dat_bar, columns = colnames(dat_bar)[grep("est_|se_", colnames(dat_bar))])
dat_bar <- construct_label(dat_bar,
  new_name = "se_Trend_noComp_20112016_percent_label",
  label_se = "se_Trend_noComp_20112016_percent",
  round_se = 1
)
dat_bar <- construct_label(dat_bar,
  new_name = "se_Trend_noComp_20162021_percent_label",
  label_se = "se_Trend_noComp_20162021_percent",
  round_se = 1
)


dat_bar$depVar <- gsub("minVerfehlt", "Mindeststandard nicht erreicht (MSA)", dat_bar$depVar)
dat_bar$depVar <- gsub("regErreicht", "Regelstandard erreicht (MSA)", dat_bar$depVar)
dat_bar$depVar <- gsub("optErreicht", "Optimalstandard erreicht (MSA)", dat_bar$depVar)

## Order the data.frame:
dat_bar$y_axis_new <- paste0(dat_bar$state_var, dat_bar$depVar)
## Dummy-variable needed for sorting:
dat_bar$depVar_fac <- factor(dat_bar$depVar, levels = c(
  "Mindeststandard nicht erreicht (MSA)",
  "Regelstandard erreicht (MSA)",
  "Optimalstandard erreicht (MSA)"
))
dat_bar <- dat_bar[order(dat_bar$state_var, dat_bar$depVar_fac), ]

## add a linebreak at the '-':
dat_bar$state_var <- gsub("-", "-<br>", dat_bar$state_var)

# Plot 1 ------------------------------------------------------------------
## Only plot the first state respectively:
dat_bar$state_var[duplicated(dat_bar$state_var)] <- " "


p_bar_1 <- plot_tablebar(
  dat = dat_bar,
  bar_est = "est_Trend_noComp_20112016_percent",
  bar_label = NULL,
  bar_sig = "sig_Trend_noComp_20112016",
  bar_header = " ",
  bar_fill = "depVar",
  columns_headers = list("**Land**", " ", "**%**", "**%**", "**%**", "*(SE)*"),
  column_spanners = list(
    "**2011**<sup>a<sup>" = 3,
    "**2016**<sup>a<sup>" = 4,
    "**Differenz 2016 - 2011**<sup>a<sup>" = c(5, 7)
  ),
  columns_table = list(
    "state_var",
    "depVar",
    "est_noTrend_noComp_2011_percent",
    "est_noTrend_noComp_2016_percent",
    "est_Trend_noComp_20112016_percent",
    "se_Trend_noComp_20112016_percent_label"
  ),
  columns_round = list(NULL, NULL, 1, 1, 1, NULL),
  columns_table_sig_bold = list(
    NULL,
    NULL,
    NULL,
    NULL,
    "sig_Trend_noComp_20112016",
    NULL
  ),
  columns_table_sig_high = list(
    NULL,
    NULL,
    NULL,
    NULL,
    "sig_Trend_CompCrossDiffWhole_20112016",
    NULL
  ),
  y_axis = "y_axis_new",
  plot_settings = plotsettings_tablebarplot(
    axis_x_lims = c(-20, 20),
    columns_alignment = c(0, 0, 2, 2, 2, 2),
    headers_alignment = c(0, 0, 0.5, 0.5, 0.5, 0.5),
    columns_width = c(0.15, 0.375, 0.07, 0.07, 0.07, 0.07, 0.225),
    default_list = barplot_table_plot_pattern
  )
)


# Plot 2 ------------------------------------------------------------------
p_bar_2 <- plot_tablebar(
  dat = dat_bar,
  bar_est = "est_Trend_noComp_20162021_percent",
  bar_label = NULL,
  bar_sig = "sig_Trend_noComp_20162021",
  bar_header = " ",
  bar_fill = "depVar",
  columns_headers = list("**%**", "**%**", "**%**", "*(SE)*"),
  column_spanners = list(
    "**2016**" = 1,
    "**2021**" = 2,
    "**Differenz 2021 - 2016**" = c(3, 5)
  ),
  columns_round = list(1, 1, 1, NULL),
  columns_table = list(
    "est_noTrend_noComp_2016_percent",
    "est_noTrend_noComp_2021_percent",
    "est_Trend_noComp_20162021_percent",
    "se_Trend_noComp_20162021_percent_label"
  ),
  columns_table_sig_bold = list(
    NULL,
    NULL,
    "sig_Trend_noComp_20162021",
    NULL
  ),
  columns_table_sig_high = list(
    NULL,
    NULL,
    "sig_Trend_CompCrossDiffWhole_20162021",
    NULL
  ),
  y_axis = "y_axis_new",
  plot_settings = plotsettings_tablebarplot(
    columns_alignment = c(2, 2, 2, 2),
    columns_width = c(0.13, 0.13, 0.13, 0.13, 0.46),
    headers_alignment = c(0.5, 0.5, 0.5, 0.5),
    pattern_spacing = 0.0125,
    default_list = barplot_table_plot_pattern
  )
)

minsta_plot_trend <- combine_plots(list(p_bar_1, p_bar_2))
minsta_plot_trend
```

```{r, eval = FALSE}
save_plot(minsta_plot_trend, filename = "../Kap3_2022_MSA_trend-v04.pdf")
```

