---
title: "Tableplots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tableplots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette shows you how to plot tableplots from `eatRep` data. 
The workflow is optimized for Bildungstrend-graphs, but can be expanded for plotting other `eatRep` data as well. 


# Trend Lesen Deutsch
```{r}
library(eatPlot)
```

In a first step, the data has to be prepared:

```{r}
trend_3_sub <- trend_3

trend_3_sub$plain <- trend_3_sub$plain[trend_3_sub$plain$comparison %in% c("crossDiff", "none", "trend"), ]

dat_prepped <- prep_tablebarplot(trend_3_sub,
  par = c("mean", "sd"),
  facet_var = "TR_BUNDESLAND",
  total_group = "total"
)
```

This results in a large dataframe, containing a column for each comparisons made in the data:

```{r}
str(dat_prepped)
```

The columns are all named after the same scheme: 

1. First, the column type is shown: `est_` for example contains estimated values, while `sig_` gives us information about the significance, `es_` about the effect size and `se_` about the standard errors of the estimates.
1. This is followed by the year(s) the value is referring to. 
If it is refering to a trend, this is indicated like so: `2015 - 2009`.
1. Then we can see the type of comparison the values in the column are referring to. 
For example, `none` means that no comparison was made, while `trend` indicates that a trend was calculated. 
`crossDiff` shows us a crossDiff and `crossDiffTotal` a crossDiff between some subgroup and an overarching total group (like a state vs. the whole of Germany). 
See [] for a more thorough description of the different comparsions available in `eatRep`. 

I'd suggest to reduce the `data.frame` by selecting the columns needed for the plot in the next step. 
This makes it easier to spot problems in the data. 
For example, I might have gathered either from the data directly, or from a template, that I will need the following columns:

```{r}
table_dat <- dat_prepped[, c(
  "TR_BUNDESLAND",
  "mhg",
  "est_2009_crossDiffTotal_mean",
  "est_2009_none_mean",
  "est_2009_none_sd",
  "est_2015_none_mean",
  "est_2015_none_sd",
  "est_2015 - 2009_trend_mean",
  "sig_2015 - 2009_trend_mean",
  "se_2015 - 2009_trend_mean",
  "es_2015 - 2009_trend_mean"
)]
```






```{r}
dat_prepped <- filter(dat_prepped, mhg %in% c("aohneZWH", "einET"), !str_detect(TR_BUNDESLAND, "- total"))
dat_prepped <- arrange(dat_prepped, TR_BUNDESLAND)

dat_prepped$TR_BUNDESLAND[duplicated(dat_prepped$TR_BUNDESLAND)] <- " "

column_widths_stand <- standardize_column_width(
  column_widths = list(
    p1 = c(0.05, 0.05, rep(0.05, 7), NA),
    p2 = c(rep(0.05, 7), NA)
  ),
  plot_ranges = c(80, 120) # Range of the x-axes of both plots set in 'axis_x_lims'.
)

p_1 <- plot_tablebar(
  dat = dat_prepped,
  bar_est = "est_2015 - 2009_trend_mean",
  bar_label = NULL,
  bar_sig = "sig_2015 - 2009_trend_mean",
  bar_fill = "mhg",
  column_spanners = list(
    "**2009**<sup>a</sup>" = c(3, 4),
    "**2015**<sup>a</sup>" = c(5, 6),
    "**Differenz 2015-2009<sup>a</sup>**" = c(7, 10)
  ),
  headers = list(
    "**Land**",
    " ",
    "*M*",
    "*SD*",
    "*M*",
    "*SD*",
    "M<sub>2015</sub> - M<sub>2009</sub>",
    "*(SE)*",
    "*d*",
    " "
  ),
  columns_table = c(
    "TR_BUNDESLAND",
    "mhg",
    "est_2009_none_mean",
    "est_2009_none_sd",
    "est_2015_none_mean",
    "est_2015_none_sd",
    "est_2015 - 2009_trend_mean",
    "se_2015 - 2009_trend_mean",
    "es_2015 - 2009_trend_mean"
  ),
  columns_table_sig_bold = list(
    NULL,
    NULL,
    "sig_2009_none_mean",
    NULL, "sig_2015_none_mean",
    NULL,
    "sig_2015 - 2009_trend_mean",
    NULL,
    NULL
  ),
  y_axis = "y_axis",
  plot_settings = plotsettings_tablebarplot(
    axis_x_lims = c(-40, 40),
    background_stripes_colour = c(rep(c("white", "white", "#EBFDF3", "#EBFDF3"), 8), "grey", "grey"),
    bar_fill_colour = c("#20D479", "#8DEBBC"),
    columns_alignment = c(0, 0, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5),
    columns_width = column_widths_stand$p1,
    headers_alignment = c(0, 0, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0),
    default_list = barplot_table_plot_pattern
  )
)

p_2 <- plot_tablebar(
  dat = dat_prepped,
  bar_est = "est_2022 - 2015_trend_mean",
  bar_label = NULL,
  bar_sig = "sig_2022 - 2015_trend_mean",
  bar_fill = "mhg",
  column_spanners = list(
    "**2015**" = c(1, 2),
    "**2022**" = c(3, 4),
    "**Differenz 2022-2015**" = c(5, 8)
  ),
  headers = list(
    "*M*",
    "*SD*",
    "*M*",
    "*SD*",
    "M<sub>2022</sub> - M<sub>2015</sub>",
    "*(SE)*",
    "*d*",
    " "
  ),
  columns_table = c(
    "est_2015_none_mean",
    "est_2015_none_sd",
    "est_2022_none_mean",
    "est_2022_none_sd",
    "est_2022 - 2015_trend_mean",
    "se_2022 - 2015_trend_mean",
    "es_2022 - 2015_trend_mean"
  ),
  columns_table_se = list(NULL, NULL, NULL, NULL, NULL, "se_2015 - 2009_trend_mean", NULL),
  columns_table_sig_bold = list(
    "sig_2015_none_mean",
    NULL,
    "sig_2022_none_mean",
    NULL,
    "sig_2022 - 2015_trend_mean",
    NULL,
    NULL
  ),
  columns_table_sig_high = list(
    "sig_2015_none_mean",
    NULL,
    "sig_2022_none_mean",
    NULL,
    "sig_2022 - 2015_trend_mean",
    NULL,
    NULL
  ),
  y_axis = "y_axis",
  plot_settings = plotsettings_tablebarplot(
    axis_x_lims = c(-60, 60),
    background_stripes_colour = c(rep(c("white", "white", "#EBFDF3", "#EBFDF3"), 8), "grey", "grey"),
    bar_fill_colour = c("#20D479", "#8DEBBC"),
    columns_alignment = c(0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5),
    columns_width = column_widths_stand$p2,
    headers_alignment = c(0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0),
    default_list = barplot_table_plot_pattern
  )
)

example_plot <- combine_plots(list(p_1, p_2))
# save_plot(example_plot, filename = "C:/Users/hafiznij/Downloads/test_table.pdf", width = 320)
# save_plot(example_plot, filename = "/home/nick/Downloads/test_table.pdf", width = 320)
```

# Geschlechterkapitel
## Abb. 6.5

Now we have to filter the data in such a way, that it looks like the table we want to plot.

```{r}
mw_prepped <- prep_tablebarplot(trend_mw, subgroup_var = "geschlecht", comparisons = c("groupDiff"))
```

It makes our live a lot easier if we set the `comparions` argument in the above column. 
This dramatically reduces the output, as only the relevant columns are prepared. 
To see which comparisons we actually need, we can take a look at the `plain` data.frame:

```{r}
#| eval: false

View(trend_mw$plain)
```

Now, the plot we want to build has some special requirements which demand some further preparation of the data. 
First of all, the example data only contains one domain, I add a second one manually. Of course you don't have to do this, its just for demonstration purposes. 

```{r}
#| code-fold: true

mw_prepped_lesen <- mw_prepped
mw_prepped_lesen$domain <- "Leseverstehen"

mw_prepped_hören <- mw_prepped
mw_prepped_hören$domain <- "Hörverstehen"

mw_prepped <- rbind(mw_prepped_lesen, mw_prepped_hören)
```




Now we can easily plot the barplot, after sorting the data.frame and adding a y-axis:

```{r}
mw_prepped <- mw_prepped[order(mw_prepped$TR_BUNDESLAND), ]
mw_prepped$y_axis <- 1:nrow(mw_prepped)
```

The tables need some more work, because they need to be connected with the barplot, but only have half the rows.
Therefore we need to build separate variables for each table part, with the respective rows of the domain not plotted in the table half set to empty strings. 

```{r}
mw_prepped_lesen <- mw_prepped
mw_prepped_lesen[mw_prepped_lesen$domain == "Hörverstehen", colnames(mw_prepped) != "y_axis"] <- NA

mw_prepped_hören <- mw_prepped
mw_prepped_hören[mw_prepped_hören$domain == "Leseverstehen", colnames(mw_prepped) != "y_axis"] <- NA


mw_preped_lh <- merge(mw_prepped_lesen, mw_prepped_hören, by = c("y_axis"), suffixes = c("_lesen", "_hören"))
mw_prepped_final <- merge(mw_prepped, mw_preped_lh, by = c("y_axis"))
```

Now we can plot the table like usual, with one exception: I can nudge the table contents a bit downwards, so they also fill the empty row. 


```{r}
p6.5 <- plot_tablebar(
  dat = mw_prepped_final,
  bar_est = "est_2022_groupDiff_mean",
  bar_fill = "domain",
  bar_sig = "sig_2022_groupDiff_mean",
  columns_table = list(
    "TR_BUNDESLAND_lesen", "est_2022_groupDiff_mean_lesen", "se_2022_groupDiff_mean_lesen", "es_2022_groupDiff_mean_lesen", "est_2022_groupDiff_mean_hören", "se_2022_groupDiff_mean_hören", "es_2022_groupDiff_mean_hören"
  ),
  columns_round = list(NULL, 0, 1, 2, 0, 1, 2),
  columns_table_se = list(NULL, NULL, "se_2022_groupDiff_mean_lesen", NULL, NULL, "se_2022_groupDiff_mean_hören", NULL),
  headers = list("", "M<sub>J</sub> - M<sub>M</sub>", "(*SE*)", "*d*", "M<sub>J</sub> - M<sub>M</sub>", "(*SE*)", "*d*", "**Vorsprung zugunsten der<br>Mädchen**"),
  column_spanners = list("Leseverstehen" = c(2, 4), "Höhrverstehen" = c(5, 7)),
  y_axis = "y_axis",
  plot_settings = plotsettings_tablebarplot(
    columns_alignment = c(0, rep(2, 6), NULL), # NULL evtl. nicht optimal, oder in die Message mit rein.
    headers_alignment = 0.5,
    headers_nudge_y = c(rep(0, 7), 0.5),
    columns_nudge_y = c(rep(-0.5, 4), rep(0.5, 3)),
    columns_width = c(0.15, rep(0.075, 6), 0.4), 
    bar_nudge_y = rep(c(-0.3, 0.3), nrow(mw_prepped_lesen) / 2),
    background_stripes_colour = rep(c("white", "white", "#EBFDF3", "#EBFDF3"), nrow(mw_prepped_lesen) / 4),
    bar_width = 0.3,
    bar_fill_colour = c("#20D479", "#8DEBBC"),
    default_list = barplot_table_plot_pattern
  )
)

```

Finally we can save the plot:

```{r}
#| eval: false
save_plot(p6.5, filename = "C:/Users/hafiznij/Downloads/abb6.5.pdf")

```

